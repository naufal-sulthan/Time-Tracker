<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Time Tracker</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; padding-top: 50px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .timer-display { font-size: 5rem; font-weight: 700; color: #2c3e50; font-family: monospace; }
        .hidden { display: none !important; }
        .btn-custom { border-radius: 50px; padding: 10px 30px; font-weight: bold; }
        .user-info { font-weight: 600; color: #555; }
    </style>
</head>
<body>

<div class="container text-center" style="max-width: 800px;">

    <div id="loginSection" class="card p-5 mt-5">
        <h1 class="mb-3">‚è±Ô∏è Pro Time Tracker</h1>
        <p class="text-muted mb-4">Catat waktu kerja Anda dengan aman dan terintegrasi Cloud.</p>
        <div>
            <button id="btnLogin" class="btn btn-primary btn-lg btn-custom shadow">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" style="margin-right:10px; background:white; border-radius:50%;">
                Login dengan Google
            </button>
        </div>
    </div>

    <div id="appSection" class="hidden">
        
        <div class="d-flex justify-content-between align-items-center mb-4 px-2">
            <div class="user-info">üë§ Halo, <span id="userName">User</span></div>
            <button id="btnLogout" class="btn btn-outline-danger btn-sm">Logout</button>
        </div>

        <div class="card p-5 mb-4 text-center">
            <div id="timer" class="timer-display">00:00:00</div>
            <div class="mt-4">
                <button id="btnStart" class="btn btn-success btn-lg btn-custom mx-2">‚ñ∂ Mulai</button>
                <button id="btnStop" class="btn btn-danger btn-lg btn-custom mx-2 hidden">‚èπ Berhenti</button>
            </div>
            <div id="statusText" class="text-muted mt-3 small">Tekan Mulai untuk bekerja</div>
        </div>

        <div class="card p-4 text-start">
            <h5 class="mb-3">üìÖ Riwayat Aktivitas Anda</h5>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Tanggal</th>
                            <th>Mulai</th>
                            <th>Selesai</th>
                            <th>Durasi</th>
                        </tr>
                    </thead>
                    <tbody id="logBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script type="module">
    // 1. IMPORT LIBRARY FIREBASE (Saya menggunakan versi stabil 10.8.0 agar kompatibel)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // 2. KONFIGURASI FIREBASE ANDA (Sesuai yang Anda kirim)
    const firebaseConfig = {
        apiKey: "AIzaSyAPOKCRgpRsXorlb1H3dgYI1beQazLlyeM",
        authDomain: "my-time-tracker-az2104.firebaseapp.com",
        projectId: "my-time-tracker-az2104",
        storageBucket: "my-time-tracker-az2104.firebasestorage.app",
        messagingSenderId: "433116282352",
        appId: "1:433116282352:web:428fef9f65ccc7e014b135",
        measurementId: "G-SL0FFM6PK9"
    };

    // 3. INISIALISASI
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app); // Opsional
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // Variabel Global
    let startTime;
    let timerInterval;
    let currentUser = null;

    // --- LOGIKA LOGIN / LOGOUT ---
    
    // Cek apakah user sedang login atau tidak
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // JIKA LOGIN
            currentUser = user;
            document.getElementById('userName').innerText = user.displayName;
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            loadLogs(user.uid); // Ambil data milik user ini
        } else {
            // JIKA BELUM LOGIN
            currentUser = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('appSection').classList.add('hidden');
        }
    });

    // Tombol Login
    document.getElementById('btnLogin').addEventListener('click', () => {
        signInWithPopup(auth, provider).catch((error) => {
            console.error("Login Error:", error);
            alert("Gagal Login: " + error.message);
        });
    });

    // Tombol Logout
    document.getElementById('btnLogout').addEventListener('click', () => {
        const confirmLogout = confirm("Yakin ingin keluar?");
        if (confirmLogout) signOut(auth);
    });

    // --- LOGIKA TIMER (STOPWATCH) ---

    document.getElementById('btnStart').addEventListener('click', () => {
        startTime = Date.now();
        
        // Ubah Tampilan Tombol
        document.getElementById('btnStart').classList.add('hidden');
        document.getElementById('btnStop').classList.remove('hidden');
        document.getElementById('statusText').innerText = "Sedang bekerja... Semangat! üî•";
        document.getElementById('statusText').classList.add('text-success');

        // Jalankan Timer
        timerInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - startTime) / 1000);
            const h = Math.floor(diff / 3600).toString().padStart(2, '0');
            const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${h}:${m}:${s}`;
        }, 1000);
    });

    document.getElementById('btnStop').addEventListener('click', async () => {
        clearInterval(timerInterval);
        const endTime = Date.now();
        const durationSec = Math.floor((endTime - startTime) / 1000);

        // Reset Tampilan
        document.getElementById('btnStop').classList.add('hidden');
        document.getElementById('btnStart').classList.remove('hidden');
        document.getElementById('timer').innerText = "00:00:00";
        document.getElementById('statusText').innerText = "Waktu tersimpan! ‚úÖ";
        document.getElementById('statusText').classList.remove('text-success');

        // SIMPAN KE FIREBASE (CLOUD)
        if (currentUser) {
            try {
                await addDoc(collection(db, "logs"), {
                    uid: currentUser.uid, // ID Unik User
                    start: new Date(startTime).toLocaleString(),
                    end: new Date(endTime).toLocaleString(),
                    duration: durationSec,
                    createdAt: serverTimestamp()
                });
            } catch (e) {
                console.error("Error saving to DB: ", e);
                alert("Gagal menyimpan data ke database. Cek koneksi internet.");
            }
        }
    });

    // --- FUNGSI LOAD DATA (REALTIME) ---
    function loadLogs(userId) {
        // Query: Ambil dari koleksi "logs", di mana uid == userId, urutkan dari yang terbaru
        const q = query(
            collection(db, "logs"), 
            where("uid", "==", userId), 
            orderBy("createdAt", "desc")
        );

        // Pasang "Telinga" (Listener) agar kalau ada data baru langsung update tanpa refresh
        onSnapshot(q, (snapshot) => {
            const tbody = document.getElementById('logBody');
            tbody.innerHTML = ''; // Kosongkan tabel
            
            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada riwayat kerja.</td></tr>';
            }

            snapshot.forEach((doc) => {
                const data = doc.data();
                
                // Format durasi jadi Jam:Menit:Detik
                const h = Math.floor(data.duration / 3600).toString().padStart(2, '0');
                const m = Math.floor((data.duration % 3600) / 60).toString().padStart(2, '0');
                const s = (data.duration % 60).toString().padStart(2, '0');

                // Potong tanggal supaya rapi
                const dateOnly = data.start.split(',')[0]; 
                const timeStart = data.start.split(',')[1] || data.start;
                const timeEnd = data.end.split(',')[1] || data.end;

                const row = `<tr>
                    <td>${dateOnly}</td>
                    <td>${timeStart}</td>
                    <td>${timeEnd}</td>
                    <td><span class="badge bg-info text-dark">${h}:${m}:${s}</span></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }, (error) => {
            console.error("Error loading logs:", error);
            // Jika error permission, biasanya karena Rules di Firebase Console belum diset
        });
    }
</script>

</body>
</html>